{% extends "base.html" %}
{% load static %}

{% block header %}{% endblock %}
{% block footer %}{% endblock %}

{% block main_container %}
<style>
  /* ===== Base Layout (æŠ•ç¨¿ä¸€è¦§ã¨åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«) ===== */
  .page {
    min-height: 100vh;
    width: 100%;
    background: linear-gradient(180deg, #bfe0ff 0%, #eaf5ff 48%, #ffffff 100%);
    display: flex;
    justify-content: center;
    box-sizing: border-box;
  }
  .inner {
    width: min(390px, 100%);
    padding: 18px 16px 90px;
    box-sizing: border-box;
    position: relative;
  }

  /* ===== Top bar (æŠ•ç¨¿ä¸€è¦§ã®å½¢å¼ã«åˆã‚ã›ã‚‹) ===== */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 2px 12px;
  }
  .back-btn {
    padding: 8px 18px;
    border-radius: 999px;
    background: #fff;
    color: #111;
    text-decoration: none;
    font-weight: 900;
    border: 2px solid rgba(0,0,0,0.35);
    box-shadow: 0 8px 14px rgba(0,0,0,0.15);
  }
  .title {
    font-size: 24px; /* ç·¨é›†ç”»é¢ãªã®ã§å°‘ã—ã‚µã‚¤ã‚ºèª¿æ•´ */
    font-weight: 900;
    color: #111;
  }
  .hamburger {
    width: 54px;
    height: 46px;
    border-radius: 14px;
    background: transparent;
    border: 0;
    cursor: pointer;
    display: grid;
    place-items: center;
    -webkit-tap-highlight-color: transparent;
  }
  .hamburger-lines {
    width: 34px;
    height: 22px;
    position: relative;
  }
  .hamburger-lines span {
    position: absolute;
    left: 0;
    right: 0;
    height: 4px;
    border-radius: 999px;
    background: #111;
  }
  .hamburger-lines span:nth-child(1) { top: 0; }
  .hamburger-lines span:nth-child(2) { top: 9px; }
  .hamburger-lines span:nth-child(3) { bottom: 0; }

  /* ===== Profile Edit Form (ç”»åƒã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å†ç¾) ===== */
  .profile-image-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 20px 0 30px;
  }
  .image-wrapper {
    width: 140px;
    height: 140px;
    border-radius: 50%;
    background: #d9d9d9;
    overflow: hidden;
    border: 2px solid rgba(0,0,0,0.3);
    margin-bottom: 12px;
  }
  .image-wrapper img { width: 100%; height: 100%; object-fit: cover; }

  .hidden-input-container { display: none; }
  
  .change-img-label {
    padding: 4px 20px;
    background: #fff;
    border: 2px solid rgba(0,0,0,0.3);
    border-radius: 999px;
    font-size: 14px;
    font-weight: 800;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }

  .field { margin-top: 24px; }
  .label { font-size: 16px; font-weight: 900; margin-bottom: 8px; display: block; }
  
  .input, .textarea {
    width: 100%;
    border-radius: 999px;
    border: 2px solid rgba(0,0,0,0.5);
    background: #fff;
    padding: 12px 20px;
    font-size: 14px;
    box-sizing: border-box;
    font-weight: 700;
    outline: none;
  }
  .textarea { border-radius: 24px; min-height: 220px; resize: none; }

  .actions { margin-top: 40px; display: flex; justify-content: center; }
  .submit-btn {
    padding: 12px 40px;
    border-radius: 999px;
    border: 2px solid rgba(0,0,0,0.3);
    background: #fff;
    font-size: 18px;
    font-weight: 900;
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    cursor: pointer;
  }

  /* ===== Drawer Styles (æŠ•ç¨¿ä¸€è¦§ã‹ã‚‰å®Œå…¨ã‚³ãƒ”ãƒ¼) ===== */
  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.18);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.16s ease;
    z-index: 100;
  }
  .drawer {
    position: fixed;
    top: 0;
    right: 0;
    height: 100vh;
    width: min(320px, 86vw);
    background: linear-gradient(180deg, #bfe0ff 0%, #eaf5ff 48%, #ffffff 100%);
    transform: translateX(102%);
    transition: transform 0.18s ease;
    box-shadow: -18px 0 30px rgba(0,0,0,0.18);
    padding: 18px 16px;
    box-sizing: border-box;
    z-index: 101;
  }
  .drawer.open { transform: translateX(0); }
  .overlay.open { opacity: 1; pointer-events: auto; }

  .drawer-top { display: flex; align-items: center; justify-content: center; position: relative; padding: 4px 0 10px; }
  .drawer-title { font-size: 22px; font-weight: 900; color: #111; }
  .drawer-close {
    position: absolute;
    right: 2px;
    top: 0;
    width: 44px;
    height: 44px;
    border: 0;
    background: transparent;
    font-size: 28px;
    font-weight: 900;
    cursor: pointer;
  }
  .drawer-profile { display: flex; align-items: center; gap: 12px; margin: 10px 0 18px; justify-content: center; }
  .drawer-avatar {
    width: 54px; height: 54px; border-radius: 999px;
    background: #d9d9d9; border: 2px solid rgba(0,0,0,0.12);
    overflow: hidden;
  }
  .drawer-avatar img { width: 100%; height: 100%; object-fit: cover; }
  .drawer-name { font-size: 18px; font-weight: 900; color: #111; font-style: italic; }

  .menu { margin-top: 8px; display: flex; flex-direction: column; gap: 14px; padding-left: 12px; }
  .menu a, .menu button {
    display: inline-flex; align-items: center; gap: 12px;
    font-size: 18px; font-weight: 900; color: #111;
    text-decoration: none; border: 0; background: transparent;
    cursor: pointer; padding: 10px 8px; border-radius: 14px;
  }
  .menu a:hover, .menu button:hover { background: rgba(255,255,255,0.55); }
  .icon { width: 26px; text-align: center; font-size: 22px; }

  .site-main, .container { padding: 0 !important; margin: 0 !important; }
</style>

<div class="page">
  <div class="inner">

    <div class="topbar">
      <a class="back-btn" href="{% url 'profile:detail' request.user.username %}">æˆ»ã‚‹</a>
      <div class="title">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</div>
      <button type="button" class="hamburger" id="openDrawer" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã">
        <div class="hamburger-lines" aria-hidden="true">
          <span></span><span></span><span></span>
        </div>
      </button>
    </div>

    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="profile-image-section">
        <div class="image-wrapper">
          <img src="{% if form.instance.icon %}{{ form.instance.icon.url }}{% else %}{% static 'images/default_icon.png' %}{% endif %}" id="preview">
        </div>
        <label for="id_icon" class="change-img-label">å¤‰æ›´</label>
        <div class="hidden-input-container">
          {{ form.icon }}
        </div>
      </div>

      <div class="field">
        <label class="label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
        {{ form.nickname }}
      </div>

      <div class="field">
        <label class="label">ä¸€è¨€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
        {{ form.bio }}
      </div>

      <div class="actions">
        <button class="submit-btn" type="submit">å¤‰æ›´ã‚’ç¢ºå®š</button>
      </div>
    </form>

  </div>
</div>

<div class="overlay" id="overlay"></div>

<aside class="drawer" id="drawer">
  <div class="drawer-top">
    <div class="drawer-title">è¨­å®š</div>
    <button type="button" class="drawer-close" id="closeDrawer">Ã—</button>
  </div>

  <div class="drawer-profile">
    <div class="drawer-avatar">
      {% if request.user.profile.icon %}
        <img src="{{ request.user.profile.icon.url }}" alt="avatar">
      {% endif %}
    </div>
    <div class="drawer-name">{{ request.user.username }}</div>
  </div>

  <div class="menu">
    <a href="{% url 'post_list' %}">
      <span class="icon">ğŸ </span>
      <span>ãƒ›ãƒ¼ãƒ </span>
    </a>
    <a href="{% url 'profile:detail' request.user.username %}">
      <span class="icon">ğŸ‘¤</span>
      <span>ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š</span>
    </a>
    <a href="javascript:void(0)" onclick="alert('é€šçŸ¥è¨­å®šã¯æœªæ¥ç¶šã§ã™');">
      <span class="icon">ğŸ””</span>
      <span>é€šçŸ¥è¨­å®š</span>
    </a>
    <form method="post" action="{% url 'logout' %}" style="margin:0;">
      {% csrf_token %}
      <button type="submit">
        <span class="icon">ğŸšª</span>
        <span>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
      </button>
    </form>
  </div>
</aside>

<script>
  // ===== Drawer open/close (æŠ•ç¨¿ä¸€è¦§ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯) =====
  (function(){
    const openBtn = document.getElementById('openDrawer');
    const closeBtn = document.getElementById('closeDrawer');
    const overlay = document.getElementById('overlay');
    const drawer = document.getElementById('drawer');

    function open(){
      overlay.classList.add('open');
      drawer.classList.add('open');
    }
    function close(){
      overlay.classList.remove('open');
      drawer.classList.remove('open');
    }

    openBtn?.addEventListener('click', open);
    closeBtn?.addEventListener('click', close);
    overlay?.addEventListener('click', close);
  })();

  // ===== Image Preview & Django Form Style =====
  document.addEventListener("DOMContentLoaded", function() {
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    const fileInput = document.querySelector('input[type="file"]');
    const previewImg = document.getElementById('preview');
    if (fileInput) {
      fileInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
          const reader = new FileReader();
          reader.onload = e => previewImg.src = e.target.result;
          reader.readAsDataURL(e.target.files[0]);
        }
      });
    }

    // ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
    const nickInput = document.querySelector('input[name="nickname"]');
    if(nickInput) nickInput.classList.add('input');
    const bioInput = document.querySelector('textarea[name="bio"]');
    if(bioInput) {
      bioInput.classList.add('textarea');
      bioInput.placeholder = "ä¸€è¨€";
    }
  });
</script>
{% endblock %}